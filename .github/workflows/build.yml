name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build configuration'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

env:
  BUILD_TYPE: ${{ inputs.build_type || 'Release' }}
  # Enable vcpkg binary caching
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  # ============================================
  # Build Dependencies (cached)
  # ============================================
  build-deps:
    name: Build Dependencies
    runs-on: windows-2022
    outputs:
      deps-cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      ryzomcore-cache-hit: ${{ steps.cache-ryzomcore.outputs.cache-hit }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      # STEP 1: Download external dependencies FIRST (RyzomCore needs these to build)
      # NOTE: No restore-keys - we need exact cache match to ensure ODE triplet is correct
      - name: Cache Dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v15

      - name: Download External Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "Downloading Ryzom external dependencies (1.3GB)..."
          $url = "https://cdn.ryzom.dev/core/2022q2_external_v143_x64.7z"
          $output = "C:/external.7z"

          # Download with progress disabled for speed
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          $ProgressPreference = 'Continue'

          # Create target directory
          New-Item -ItemType Directory -Force -Path "C:/external"

          Write-Host "Extracting dependencies to C:/external..."
          7z x $output -oC:/external -y

          # List what was extracted (both files and directories)
          Write-Host "Extracted contents (directories):"
          Get-ChildItem C:/external -Directory | Select-Object Name
          Write-Host "Extracted contents (files at root):"
          Get-ChildItem C:/external -File | Select-Object Name

          # RyzomCore requires CMakeLists.txt in external directory
          if (!(Test-Path "C:/external/CMakeLists.txt")) {
            Write-Warning "CMakeLists.txt not found in C:/external - checking for nested structure..."

            # Check if there's a nested "external" folder from the archive
            $nested = Get-ChildItem C:/external -Directory | Where-Object {
              Test-Path "$($_.FullName)/CMakeLists.txt"
            } | Select-Object -First 1

            if ($nested) {
              Write-Host "Found CMakeLists.txt in nested folder: $($nested.Name)"
              Write-Host "Moving contents up one level..."
              Get-ChildItem $nested.FullName | Move-Item -Destination "C:/external/" -Force
              Remove-Item $nested.FullName -Recurse -Force -ErrorAction SilentlyContinue
            } else {
              Write-Warning "No CMakeLists.txt found in any subdirectory"
              Write-Host "This external package may not be compatible with RyzomCore"
            }
          }

          # Cleanup archive to save space
          Remove-Item $output

          # ===========================================
          # REQUIRED FILES MANIFEST
          # This is the definitive list of files needed for building.
          # The cleanup step will preserve these, and verification will check them.
          # ===========================================
          $requiredLibs = @(
            # Core libraries
            "libxml2/lib/libxml2.lib",
            "zlib/lib/zlib.lib",
            "lua/lib/lua.lib",
            "luabind/lib/luabind.lib",
            # Networking
            "curl/lib/libcurl_imp.lib",
            "openssl/lib/VC/libcrypto64MD.lib",
            "openssl/lib/VC/libssl64MD.lib",
            # Graphics
            "freetype/lib/freetype.lib",
            "libpng/lib/libpng16.lib",
            "libjpeg/lib/jpeg.lib",
            # Audio
            "ogg/lib/ogg.lib",
            "vorbis/lib/vorbis.lib",
            "vorbis/lib/vorbisfile.lib",
            "openal-soft/lib/OpenAL32.lib"
          )

          $requiredDLLs = @(
            "lua/bin/lua.dll",
            "libxml2/bin/libxml2.dll",
            "zlib/bin/zlib.dll",
            "curl/bin/libcurl.dll",
            "openssl/bin/libcrypto-1_1-x64.dll",
            "openssl/bin/libssl-1_1-x64.dll",
            "freetype/bin/freetype.dll",
            "libpng/bin/libpng16.dll",
            "libjpeg/bin/jpeg62.dll",
            "ogg/bin/ogg.dll",
            "vorbis/bin/vorbis.dll",
            "vorbis/bin/vorbisfile.dll",
            "openal-soft/bin/OpenAL32.dll"
          )

          $requiredHeaders = @(
            "libxml2/include/libxml2/libxml/xmlversion.h",
            "lua/include/lua.h",
            "luabind/include/luabind/luabind.hpp",
            "curl/include/curl/curl.h",
            "openssl/include/openssl/ssl.h",
            "zlib/include/zlib.h",
            "freetype/include/freetype2/ft2build.h",
            "libpng/include/png.h",
            "libjpeg/include/jpeglib.h",
            "ogg/include/ogg/ogg.h",
            "vorbis/include/vorbis/vorbisfile.h",
            "openal-soft/include/AL/al.h",
            "boost/include/boost/version.hpp"
          )

          # Combine all required files for verification
          $allRequiredFiles = $requiredLibs + $requiredDLLs + $requiredHeaders

          Write-Host "`n=== Verifying required files after extraction ==="
          $missingFiles = @()
          foreach ($file in $allRequiredFiles) {
            $fullPath = "C:/external/$file"
            if (!(Test-Path $fullPath)) {
              $missingFiles += $file
              Write-Host "[MISSING] $file"
            }
          }
          if ($missingFiles.Count -gt 0) {
            Write-Error "Missing $($missingFiles.Count) required files after extraction!"
            exit 1
          }
          Write-Host "All $($allRequiredFiles.Count) required files present"

          # Remove all OpenSSL libs except the specific release ones we need
          # (FindOpenSSL returns "optimized;...;debug;..." format which modern CMake
          # doesn't allow in INTERFACE_LINK_LIBRARIES)
          Write-Host "`nCleaning OpenSSL libs - keeping only release MSVC libs..."
          $keepLibs = @(
            "libcrypto64MD.lib",
            "libssl64MD.lib"
          )
          # Delete all .lib files in openssl/lib recursively, except the ones we want (by filename)
          Get-ChildItem "C:/external/openssl/lib" -Recurse -Filter "*.lib" | ForEach-Object {
            if ($keepLibs -notcontains $_.Name) {
              Remove-Item $_.FullName -Force
              Write-Host "Removed: $($_.FullName)"
            } else {
              Write-Host "Kept: $($_.FullName)"
            }
          }

          # Also remove Luabind debug lib
          if (Test-Path "C:/external/luabind/lib/luabindd.lib") {
            Remove-Item "C:/external/luabind/lib/luabindd.lib" -Force
            Write-Host "Removed: C:/external/luabind/lib/luabindd.lib"
          }

          # Remove libxml2 debug lib
          if (Test-Path "C:/external/libxml2/lib/libxml2d.lib") {
            Remove-Item "C:/external/libxml2/lib/libxml2d.lib" -Force
            Write-Host "Removed: C:/external/libxml2/lib/libxml2d.lib"
          }

          # === AGGRESSIVE CLEANUP to reduce cache size ===
          Write-Host "`n=== Aggressive cleanup to reduce cache size ==="
          $beforeSize = (Get-ChildItem "C:/external" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Size before cleanup: $([math]::Round($beforeSize, 2)) MB"

          # Remove all debug symbol files (.pdb)
          Write-Host "`nRemoving .pdb debug symbols..."
          Get-ChildItem "C:/external" -Recurse -Filter "*.pdb" -ErrorAction SilentlyContinue |
            Remove-Item -Force -ErrorAction SilentlyContinue

          # Remove documentation, samples, tests, examples directories
          Write-Host "Removing docs, samples, tests, examples..."
          Get-ChildItem "C:/external" -Recurse -Directory -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -match "^(doc|docs|documentation|sample|samples|test|tests|example|examples|man|manual|tutorial|tutorials|demo|demos)$" } |
            Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # Remove all debug libraries (*d.lib, *_d.lib, *_debug.lib)
          # Use -cmatch for case-sensitive matching to avoid removing libs like libcrypto64MD.lib
          Write-Host "Removing debug libraries..."
          Get-ChildItem "C:/external" -Recurse -Filter "*.lib" -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -cmatch "d\.lib$|_d\.lib$|_debug\.lib$" } |
            ForEach-Object {
              Remove-Item $_.FullName -Force -ErrorAction SilentlyContinue
              Write-Host "Removed debug lib: $($_.Name)"
            }

          # Remove CMake package config files (not needed at runtime)
          Write-Host "Removing CMake config files..."
          Get-ChildItem "C:/external" -Recurse -Directory -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -eq "cmake" -or $_.Name -eq "pkgconfig" } |
            Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # Remove .exe tools we don't need (xml tools, curl.exe, etc.)
          Write-Host "Removing unnecessary executables..."
          $keepExes = @("lua.exe", "luac.exe")  # Keep Lua interpreter
          Get-ChildItem "C:/external" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue |
            Where-Object { $keepExes -notcontains $_.Name } |
            Remove-Item -Force -ErrorAction SilentlyContinue

          # Remove static libraries we don't need
          # Note: We use libcurl_imp.lib (DLL import lib), not libcurl.lib (static)
          Write-Host "Removing unnecessary static libraries..."
          $staticLibsToRemove = @(
            "C:/external/zlib/lib/zlibstatic.lib"    # We use zlib.lib (DLL import)
          )
          foreach ($lib in $staticLibsToRemove) {
            if (Test-Path $lib) {
              Remove-Item $lib -Force -ErrorAction SilentlyContinue
              Write-Host "Removed: $lib"
            }
          }

          $afterSize = (Get-ChildItem "C:/external" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "`nSize after cleanup: $([math]::Round($afterSize, 2)) MB"
          Write-Host "Saved: $([math]::Round($beforeSize - $afterSize, 2)) MB"

          # ===========================================
          # VERIFY REQUIRED FILES AFTER CLEANUP
          # This ensures cleanup didn't accidentally delete anything we need
          # ===========================================
          Write-Host "`n=== Verifying required files after cleanup ==="
          $missingAfterCleanup = @()
          foreach ($file in $allRequiredFiles) {
            $fullPath = "C:/external/$file"
            if (!(Test-Path $fullPath)) {
              $missingAfterCleanup += $file
              Write-Host "[DELETED BY CLEANUP] $file"
            }
          }
          if ($missingAfterCleanup.Count -gt 0) {
            Write-Error "Cleanup deleted $($missingAfterCleanup.Count) required files! Fix the cleanup rules."
            exit 1
          }
          Write-Host "All $($allRequiredFiles.Count) required files still present after cleanup"

          Write-Host "`nExternal dependencies ready at C:/external"
          Write-Host "Final structure:"
          Get-ChildItem C:/external | Select-Object Mode, Name

          # Show Ryzom's recommended CMake prefix path
          if (Test-Path "C:/external/cmake_prefix_path_ryz.txt") {
            Write-Host "`nRyzom CMAKE_PREFIX_PATH recommendation:"
            Get-Content "C:/external/cmake_prefix_path_ryz.txt"
          }

          # Check libxml2 structure
          Write-Host "`nlibxml2 lib contents:"
          Get-ChildItem "C:/external/libxml2/lib" -ErrorAction SilentlyContinue

          # CRITICAL: Check if libxml2.dll exports xmlFree
          Write-Host "`n=== Checking libxml2.dll exports for xmlFree ==="
          if (Test-Path "C:/external/libxml2/bin/libxml2.dll") {
            $exports = dumpbin /exports "C:/external/libxml2/bin/libxml2.dll" 2>&1 | Out-String
            if ($exports -match "xmlFree") {
              Write-Host "FOUND: xmlFree is exported by libxml2.dll"
              $exports | Select-String -Pattern "xmlFree|xmlMalloc|xmlRealloc|xmlMemStrdup"
            } else {
              Write-Host "WARNING: xmlFree NOT exported by libxml2.dll!"
              Write-Host "Checking for alternative memory functions..."
              $exports | Select-String -Pattern "Mem|alloc|free" -CaseSensitive:$false | Select-Object -First 10
            }
          } else {
            Write-Host "ERROR: libxml2.dll not found at C:/external/libxml2/bin/"
            Get-ChildItem "C:/external/libxml2" -Recurse -Filter "*.dll" | Select-Object FullName
          }

          # Check libxml2.lib import symbols
          Write-Host "`n=== Checking libxml2.lib for xmlFree import ==="
          dumpbin /all "C:/external/libxml2/lib/libxml2.lib" 2>&1 | Select-String -Pattern "xmlFree" | Select-Object -First 5

          # Print the FULL xmlexports.h to understand how symbols are declared
          Write-Host "`n=== Full xmlexports.h content ==="
          if (Test-Path "C:/external/libxml2/include/libxml2/libxml/xmlexports.h") {
            Get-Content "C:/external/libxml2/include/libxml2/libxml/xmlexports.h"
          } else {
            Write-Host "xmlexports.h not found!"
          }

      # Install ODE physics library (not in Ryzom external package)
      - name: Install ODE
        shell: pwsh
        run: |
          # Skip if ODE already exists from cache
          if (Test-Path "C:/external/ode/include/ode/ode.h") {
            Write-Host "ODE already installed, skipping..."
            exit 0
          }

          Write-Host "Installing ODE via vcpkg..."
          # vcpkg is pre-installed on GitHub Actions runners
          # Use x64-windows-static-md triplet: static library with dynamic CRT (/MD)
          # This matches how tux_target is built (dynamic CRT)
          vcpkg install ode:x64-windows-static-md

          # Copy to C:/external/ode for consistency
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          if (-not $vcpkgRoot) {
            $vcpkgRoot = "C:\vcpkg"
          }

          $installedDir = "$vcpkgRoot\installed\x64-windows-static-md"
          if (Test-Path $installedDir) {
            New-Item -ItemType Directory -Force -Path "C:/external/ode/include"
            New-Item -ItemType Directory -Force -Path "C:/external/ode/lib"

            # Copy headers
            if (Test-Path "$installedDir/include/ode") {
              Copy-Item -Recurse "$installedDir/include/ode" "C:/external/ode/include/"
              Write-Host "Copied ODE headers"
            }

            # Copy libraries - ODE names vary: ode.lib, ode_double.lib, ode_doubles.lib
            # Copy all found libs and create a consistent name (ode_doubles.lib) for our CMake
            Get-ChildItem "$installedDir/lib" -Filter "ode*.lib" | ForEach-Object {
              Copy-Item $_.FullName "C:/external/ode/lib/"
              Write-Host "Copied: $($_.Name)"
              # Also copy as ode_doubles.lib if it has a different name
              if ($_.Name -ne "ode_doubles.lib") {
                Copy-Item $_.FullName "C:/external/ode/lib/ode_doubles.lib"
                Write-Host "Also copied as: ode_doubles.lib"
              }
            }

            Write-Host "`nODE installation complete:"
            Get-ChildItem "C:/external/ode" -Recurse | Select-Object FullName
          } else {
            Write-Error "vcpkg install directory not found: $installedDir"
          }

      # Verify deps exist (runs even with cache hit for debugging)
      - name: Verify Dependencies
        shell: pwsh
        run: |
          Write-Host "=== Verifying external dependencies ==="
          Write-Host "`nlibxml2 lib contents:"
          Get-ChildItem "C:/external/libxml2/lib" -Filter "*.lib" -ErrorAction SilentlyContinue

          # CRITICAL: Check if libxml2.dll exports xmlFree
          Write-Host "`n=== CRITICAL: Checking libxml2.dll exports for xmlFree ==="
          if (Test-Path "C:/external/libxml2/bin/libxml2.dll") {
            Write-Host "Running dumpbin /exports on libxml2.dll..."
            $exports = dumpbin /exports "C:/external/libxml2/bin/libxml2.dll" 2>&1 | Out-String
            if ($exports -match "xmlFree") {
              Write-Host "FOUND: xmlFree is exported by libxml2.dll"
              echo $exports | Select-String -Pattern "xmlFree|xmlMalloc|xmlRealloc|xmlMemStrdup"
            } else {
              Write-Host "WARNING: xmlFree NOT exported by libxml2.dll!"
              Write-Host "Searching for any memory-related exports..."
              echo $exports | Select-String -Pattern "Mem|alloc|free" -CaseSensitive:$false | Select-Object -First 15
            }
          } else {
            Write-Host "ERROR: libxml2.dll not found at C:/external/libxml2/bin/"
            Get-ChildItem "C:/external/libxml2" -Recurse -Filter "*.dll" | Select-Object FullName
          }

          # Check libxml2.lib for xmlFree symbol
          Write-Host "`n=== Checking libxml2.lib for xmlFree symbol ==="
          dumpbin /all "C:/external/libxml2/lib/libxml2.lib" 2>&1 | Select-String -Pattern "xmlFree" | Select-Object -First 10

          # Print xmlexports.h to understand XMLPUBVAR definition
          Write-Host "`n=== libxml2 xmlexports.h content ==="
          if (Test-Path "C:/external/libxml2/include/libxml2/libxml/xmlexports.h") {
            Get-Content "C:/external/libxml2/include/libxml2/libxml/xmlexports.h"
          } else {
            Write-Host "xmlexports.h not found!"
          }

          Write-Host "`nOpenSSL lib contents:"
          Get-ChildItem "C:/external/openssl/lib/VC" -Filter "*.lib" -ErrorAction SilentlyContinue
          Write-Host "`nLuabind lib contents:"
          Get-ChildItem "C:/external/luabind/lib" -Filter "*.lib" -ErrorAction SilentlyContinue
          Write-Host "`nODE structure:"
          if (Test-Path "C:/external/ode") {
            Get-ChildItem "C:/external/ode" -Recurse -Include "*.h","*.lib" | Select-Object FullName
          } else {
            Write-Host "ODE directory not found!"
          }

      # STEP 2: Build RyzomCore (requires external deps)
      - name: Cache RyzomCore
        id: cache-ryzomcore
        uses: actions/cache@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v21
          # No restore-keys fallback - we want exact match only to avoid stale caches

      - name: Build RyzomCore
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Clean up any stale directory from failed cache restore
          if (Test-Path "C:/ryzomcore") {
            Remove-Item -Recurse -Force "C:/ryzomcore"
          }

          Write-Host "Cloning RyzomCore..."
          git clone --depth 1 https://github.com/ryzom/ryzomcore.git C:/ryzomcore

          Write-Host "Configuring RyzomCore..."
          cd C:/ryzomcore
          mkdir build
          cd build

          # Point to external dependencies via CMAKE_PREFIX_PATH
          $cmakePrefixPath = "C:/external/zlib;C:/external/libpng;C:/external/libjpeg;C:/external/curl;C:/external/openssl;C:/external/freetype;C:/external/ogg;C:/external/vorbis;C:/external/openal-soft;C:/external/boost;C:/external/lua;C:/external/luabind;C:/external/libxml2"

          # Use Ninja generator for faster builds
          # Find cl.exe using where.exe (more reliable than relying on PATH in cmake)
          $ninjaPath = "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe"
          $clPath = (Get-Command cl.exe -ErrorAction SilentlyContinue).Source
          if (-not $clPath) {
            # Fallback: use where.exe
            $clPath = (where.exe cl.exe 2>$null | Select-Object -First 1)
          }
          if (-not $clPath) {
            Write-Error "Could not find cl.exe! MSVC environment may not be set up correctly."
            exit 1
          }
          Write-Host "Found cl.exe at: $clPath"

          # IMPORTANT: Do NOT define LIBXML_STATIC!
          # The Ryzom external package provides libxml2 as a DLL (libxml2.dll + libxml2.lib import library).
          # When linking against a DLL:
          # - Without LIBXML_STATIC: xmlexports.h uses __declspec(dllimport) -> linker expects __imp_xmlFree
          # - With LIBXML_STATIC: xmlexports.h uses plain extern -> linker expects xmlFree (not in import lib!)
          # The import library (libxml2.lib) contains __imp_xmlFree, so we must NOT use LIBXML_STATIC.
          Write-Host "Using DLL linkage for libxml2 (no LIBXML_STATIC)"

          # Search for where RyzomCore sets LIBXML_STATIC
          Write-Host "`n=== Searching for LIBXML_STATIC in RyzomCore CMake files ==="
          Get-ChildItem -Path "C:/ryzomcore" -Recurse -Include "*.cmake","CMakeLists.txt" -ErrorAction SilentlyContinue |
            ForEach-Object {
              $content = Get-Content $_.FullName -Raw -ErrorAction SilentlyContinue
              if ($content -match "LIBXML_STATIC|LIBXML2_DEFINITIONS") {
                Write-Host "`nFound in: $($_.FullName)"
                $content | Select-String -Pattern "LIBXML_STATIC|LIBXML2_DEFINITIONS" -Context 2,2 | ForEach-Object { Write-Host $_ }
              }
            }

          cmake .. -G Ninja `
            -DCMAKE_MAKE_PROGRAM="$ninjaPath" `
            -DCMAKE_C_COMPILER="$clPath" `
            -DCMAKE_CXX_COMPILER="$clPath" `
            -DCMAKE_BUILD_TYPE=Release `
            -DWITH_SOUND=ON `
            -DWITH_NEL=ON `
            -DWITH_NEL_TOOLS=OFF `
            -DWITH_NEL_TESTS=OFF `
            -DWITH_NEL_SAMPLES=OFF `
            -DWITH_RYZOM=OFF `
            -DWITH_RYZOM_CLIENT=OFF `
            -DWITH_RYZOM_SERVER=OFF `
            -DWITH_RYZOM_TOOLS=OFF `
            -DWITH_NELNS=OFF `
            -DWITH_SNOWBALLS=OFF `
            -DWITH_STATIC=ON `
            -DWITH_STATIC_LIBXML2=OFF `
            -DLIBXML2_DEFINITIONS="" `
            "-DCMAKE_PREFIX_PATH=$cmakePrefixPath" `
            -DLUA_INCLUDE_DIR=C:/external/lua/include `
            -DLUA_LIBRARIES=C:/external/lua/lib/lua51.lib `
            -DLUABIND_INCLUDE_DIR=C:/external/luabind/include `
            -DLUABIND_LIBRARY=C:/external/luabind/lib/luabind.lib `
            -DLUABIND_LIBRARIES=C:/external/luabind/lib/luabind.lib `
            -DLIBXML2_INCLUDE_DIR=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY=C:/external/libxml2/lib/libxml2.lib `
            -DLIBXML2_LIBRARIES=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_INCLUDE_DIR=C:/external/zlib/include `
            -DZLIB_LIBRARIES=C:/external/zlib/lib/zlib.lib `
            -DZLIB_LIBRARY=C:/external/zlib/lib/zlib.lib `
            -DPNG_PNG_INCLUDE_DIR=C:/external/libpng/include `
            -DPNG_LIBRARY=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR=C:/external/libjpeg/include `
            -DJPEG_LIBRARY=C:/external/libjpeg/lib/jpeg.lib `
            -DFREETYPE_INCLUDE_DIRS=C:/external/freetype/include/freetype2 `
            -DFREETYPE_LIBRARY=C:/external/freetype/lib/freetype.lib `
            -DOPENAL_INCLUDE_DIR=C:/external/openal-soft/include `
            -DOPENAL_LIBRARY=C:/external/openal-soft/lib/OpenAL32.lib `
            -DOGG_INCLUDE_DIR=C:/external/ogg/include `
            -DOGG_LIBRARY=C:/external/ogg/lib/ogg.lib `
            -DVORBIS_INCLUDE_DIR=C:/external/vorbis/include `
            -DVORBIS_LIBRARY=C:/external/vorbis/lib/vorbis.lib `
            -DVORBISFILE_LIBRARY=C:/external/vorbis/lib/vorbisfile.lib `
            -DBoost_INCLUDE_DIR=C:/external/boost/include `
            -DOPENSSL_ROOT_DIR=C:/external/openssl `
            -DOPENSSL_CRYPTO_LIBRARY=C:/external/openssl/lib/VC/libcrypto64MD.lib `
            -DOPENSSL_SSL_LIBRARY=C:/external/openssl/lib/VC/libssl64MD.lib `
            -DOPENSSL_LIBRARIES="C:/external/openssl/lib/VC/libcrypto64MD.lib;C:/external/openssl/lib/VC/libssl64MD.lib" `
            -DCMAKE_FIND_USE_SYSTEM_ENVIRONMENT_PATH=FALSE

          # Debug: Check CMake cache for LIBXML settings
          Write-Host "`n=== CMake Cache LIBXML settings ==="
          Get-Content CMakeCache.txt | Select-String -Pattern "LIBXML" | ForEach-Object { Write-Host $_ }

          # Debug: Check compile_commands.json for LIBXML_STATIC
          if (Test-Path "compile_commands.json") {
            Write-Host "`n=== Checking compile_commands.json for LIBXML_STATIC ==="
            $compileCommands = Get-Content "compile_commands.json" -Raw
            if ($compileCommands -match "LIBXML_STATIC") {
              Write-Host "WARNING: LIBXML_STATIC found in compile commands!"
              $compileCommands | Select-String -Pattern "LIBXML_STATIC" | Select-Object -First 3 | ForEach-Object { Write-Host $_ }
            } else {
              Write-Host "OK: LIBXML_STATIC NOT found in compile commands"
            }
          }

          Write-Host "`nBuilding RyzomCore..."
          cmake --build . --parallel 4 --target nelmisc nelnet nel3d nelsound nelsnd_lowlevel nelgeorges nelligo
          cmake --build . --parallel 2 --target nel_drv_opengl_win nel_drv_openal_win

      - name: Verify RyzomCore Build
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Ninja outputs to lib/ and bin/ directly (no Release subdirectory)
          $required = @(
            "C:/ryzomcore/build/lib/nelmisc_r.lib",
            "C:/ryzomcore/build/lib/nel3d_r.lib",
            "C:/ryzomcore/build/lib/nelnet_r.lib",
            "C:/ryzomcore/build/lib/nelsound_r.lib",
            "C:/ryzomcore/build/lib/nelsnd_lowlevel_r.lib",
            "C:/ryzomcore/build/lib/nelgeorges_r.lib",
            "C:/ryzomcore/build/lib/nelligo_r.lib",
            "C:/ryzomcore/build/bin/nel_drv_opengl_win_r.dll",
            "C:/ryzomcore/build/bin/nel_drv_openal_win_r.dll"
          )
          $missing = @()
          foreach ($file in $required) {
            if (!(Test-Path $file)) {
              $missing += $file
            }
          }
          if ($missing.Count -gt 0) {
            Write-Error "RyzomCore build incomplete. Missing files:"
            $missing | ForEach-Object { Write-Error "  - $_" }
            exit 1
          }
          Write-Host "RyzomCore build verified successfully - all $($required.Count) files present"

  # ============================================
  # Build Client
  # ============================================
  build-client:
    name: Build Client
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v21
          fail-on-cache-miss: true

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v15
          restore-keys: |
            ryzom-external-2022q2-

      - name: Verify Required Files
        shell: pwsh
        run: |
          Write-Host "=== Verifying all required files for client build ==="

          # Same manifest as in build-deps (keep in sync!)
          $requiredLibs = @(
            "libxml2/lib/libxml2.lib",
            "zlib/lib/zlib.lib",
            "lua/lib/lua.lib",
            "luabind/lib/luabind.lib",
            "curl/lib/libcurl_imp.lib",
            "openssl/lib/VC/libcrypto64MD.lib",
            "openssl/lib/VC/libssl64MD.lib",
            "freetype/lib/freetype.lib",
            "libpng/lib/libpng16.lib",
            "libjpeg/lib/jpeg.lib",
            "ogg/lib/ogg.lib",
            "vorbis/lib/vorbis.lib",
            "vorbis/lib/vorbisfile.lib",
            "openal-soft/lib/OpenAL32.lib"
          )

          $requiredDLLs = @(
            "lua/bin/lua.dll",
            "libxml2/bin/libxml2.dll",
            "zlib/bin/zlib.dll",
            "curl/bin/libcurl.dll",
            "openssl/bin/libcrypto-1_1-x64.dll",
            "openssl/bin/libssl-1_1-x64.dll",
            "freetype/bin/freetype.dll",
            "libpng/bin/libpng16.dll",
            "libjpeg/bin/jpeg62.dll",
            "ogg/bin/ogg.dll",
            "vorbis/bin/vorbis.dll",
            "vorbis/bin/vorbisfile.dll",
            "openal-soft/bin/OpenAL32.dll"
          )

          $allRequired = $requiredLibs + $requiredDLLs
          $missing = @()

          foreach ($file in $allRequired) {
            $fullPath = "C:/external/$file"
            if (Test-Path $fullPath) {
              Write-Host "[OK] $file"
            } else {
              $missing += $file
              Write-Host "[MISSING] $file"
            }
          }

          if ($missing.Count -gt 0) {
            Write-Error "Missing $($missing.Count) required files! Cache may be corrupted."
            exit 1
          }
          Write-Host "`nAll $($allRequired.Count) required files verified"

      - name: Configure CMake (Client)
        shell: pwsh
        run: |
          mkdir build-client
          cd build-client
          # Use :FILEPATH type to ensure CMake treats these as cache variables
          # that won't be overwritten by find modules
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DBUILD_CLIENT=ON `
            -DBUILD_SERVER=OFF `
            -DWITH_STATIC=ON `
            -DWITH_STATIC_CURL=ON `
            -DNEL_PREFIX_PATH=C:/ryzomcore/build `
            -DCMAKE_PREFIX_PATH=C:/external `
            -DLUA_INCLUDE_DIR:PATH=C:/external/lua/include `
            -DLUA_LIBRARIES:FILEPATH=C:/external/lua/lib/lua.lib `
            -DLIBXML2_INCLUDE_DIR:PATH=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY:FILEPATH=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_ROOT=C:/external/zlib `
            -DZLIB_LIBRARY:FILEPATH=C:/external/zlib/lib/zlib.lib `
            -DCURL_ROOT=C:/external/curl `
            -DCURL_INCLUDE_DIR:PATH=C:/external/curl/include `
            -DCURL_LIBRARY:FILEPATH=C:/external/curl/lib/libcurl_imp.lib `
            -DCURL_LIBRARIES:FILEPATH=C:/external/curl/lib/libcurl_imp.lib `
            -DOPENSSL_ROOT_DIR=C:/external/openssl `
            -DFREETYPE_INCLUDE_DIRS:PATH=C:/external/freetype/include/freetype2 `
            -DFREETYPE_LIBRARY:FILEPATH=C:/external/freetype/lib/freetype.lib `
            -DPNG_PNG_INCLUDE_DIR:PATH=C:/external/libpng/include `
            -DPNG_LIBRARY:FILEPATH=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR:PATH=C:/external/libjpeg/include `
            -DJPEG_LIBRARY:FILEPATH=C:/external/libjpeg/lib/jpeg.lib `
            -DVORBIS_LIBRARY:FILEPATH=C:/external/vorbis/lib/vorbis.lib `
            -DVORBISFILE_LIBRARY:FILEPATH=C:/external/vorbis/lib/vorbisfile.lib `
            -DOGG_LIBRARY:FILEPATH=C:/external/ogg/lib/ogg.lib

      - name: Build Client
        run: cmake --build build-client --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Prepare Client Artifact
        shell: pwsh
        run: |
          $releaseDir = "build-client/bin/${{ env.BUILD_TYPE }}"
          $depsDir = "C:/external"

          # Copy NeL drivers (Ninja outputs to bin/ directly, no Release subdirectory)
          if (Test-Path "C:/ryzomcore/build/bin/nel_drv_opengl_win_r.dll") {
            Copy-Item "C:/ryzomcore/build/bin/nel_drv_opengl_win_r.dll" "$releaseDir/"
          }
          if (Test-Path "C:/ryzomcore/build/bin/nel_drv_openal_win_r.dll") {
            Copy-Item "C:/ryzomcore/build/bin/nel_drv_openal_win_r.dll" "$releaseDir/"
          }

          # Copy runtime DLLs from dependencies
          $dllSources = @(
            "$depsDir/lua/bin/lua.dll",
            "$depsDir/libxml2/bin/libxml2.dll",
            "$depsDir/zlib/bin/zlib.dll",
            "$depsDir/curl/bin/libcurl.dll",
            "$depsDir/openssl/bin/libcrypto-1_1-x64.dll",
            "$depsDir/openssl/bin/libssl-1_1-x64.dll",
            "$depsDir/freetype/bin/freetype.dll",
            "$depsDir/libpng/bin/libpng16.dll",
            "$depsDir/libjpeg/bin/jpeg62.dll",
            "$depsDir/ogg/bin/ogg.dll",
            "$depsDir/vorbis/bin/vorbis.dll",
            "$depsDir/vorbis/bin/vorbisfile.dll",
            "$depsDir/openal-soft/bin/OpenAL32.dll"
          )
          foreach ($dll in $dllSources) {
            if (Test-Path $dll) {
              Copy-Item $dll "$releaseDir/" -ErrorAction SilentlyContinue
              Write-Host "Copied: $dll"
            } else {
              Write-Warning "DLL not found: $dll"
            }
          }

          # Copy ALL game data (fonts, textures, shapes, levels, etc.)
          Write-Host "Copying game data..."
          if (Test-Path "data") {
            New-Item -ItemType Directory -Force -Path "$releaseDir/data" | Out-Null
            Copy-Item -Recurse -Force "data/*" "$releaseDir/data/"
            Write-Host "Copied data directory"
          }

          # Copy fonts from RyzomCore samples (required for client)
          $ryzomFontDir = "C:/ryzomcore/nel/samples/3d"
          if (Test-Path "$ryzomFontDir/cegui/datafiles/n019003l.pfb") {
            Copy-Item "$ryzomFontDir/cegui/datafiles/n019003l.pfb" "$releaseDir/data/font/"
            Write-Host "Copied: n019003l.pfb"
          }
          if (Test-Path "$ryzomFontDir/font/beteckna.ttf") {
            Copy-Item "$ryzomFontDir/font/beteckna.ttf" "$releaseDir/data/font/bigfont.ttf"
            Write-Host "Copied: bigfont.ttf"
          }

          # Copy GUI from client/data/gui if exists
          if (Test-Path "client/data/gui") {
            New-Item -ItemType Directory -Force -Path "$releaseDir/data/gui" | Out-Null
            Copy-Item -Recurse -Force "client/data/gui/*" "$releaseDir/data/gui/"
            Write-Host "Copied GUI files"
          }

          # Create additional directories
          New-Item -ItemType Directory -Force -Path "$releaseDir/cache" | Out-Null
          New-Item -ItemType Directory -Force -Path "$releaseDir/replay" | Out-Null
          New-Item -ItemType Directory -Force -Path "$releaseDir/logs" | Out-Null

          # Copy config
          if (Test-Path "data/config/mtp_target_default.cfg") {
            Copy-Item "data/config/mtp_target_default.cfg" "$releaseDir/"
          } elseif (Test-Path "client/mtp_target_default.cfg") {
            Copy-Item "client/mtp_target_default.cfg" "$releaseDir/"
          }

          # Create tux-target.cfg wrapper
          if (!(Test-Path "$releaseDir/tux-target.cfg")) {
            '// This file tells the client where to find the main config' | Set-Content "$releaseDir/tux-target.cfg"
            'RootConfigFilename = "mtp_target_default.cfg";' | Add-Content "$releaseDir/tux-target.cfg"
            Write-Host "Created: tux-target.cfg"
          }

      - name: Upload Client Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tux-target-client-windows-${{ env.BUILD_TYPE }}
          path: |
            build-client/bin/${{ env.BUILD_TYPE }}/tux-target.exe
            build-client/bin/${{ env.BUILD_TYPE }}/*.dll
            build-client/bin/${{ env.BUILD_TYPE }}/data/
            build-client/bin/${{ env.BUILD_TYPE }}/*.cfg
          retention-days: 30

  # ============================================
  # Build Server
  # ============================================
  build-server:
    name: Build Server
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v21
          fail-on-cache-miss: true

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v15
          restore-keys: |
            ryzom-external-2022q2-

      - name: Verify ODE Installation
        shell: pwsh
        run: |
          Write-Host "=== Checking ODE directory structure ==="
          if (Test-Path "C:/external/ode") {
            Write-Host "ODE directory exists"
            Write-Host "`nODE include structure:"
            Get-ChildItem "C:/external/ode/include" -Recurse -ErrorAction SilentlyContinue |
              Select-Object FullName |
              ForEach-Object { Write-Host $_.FullName }

            Write-Host "`nODE lib structure:"
            Get-ChildItem "C:/external/ode/lib" -Recurse -Filter "*.lib" -ErrorAction SilentlyContinue |
              Select-Object FullName |
              ForEach-Object { Write-Host $_.FullName }

            # Check specifically for ode/ode.h
            if (Test-Path "C:/external/ode/include/ode/ode.h") {
              Write-Host "`n[OK] Found: C:/external/ode/include/ode/ode.h"
            } else {
              Write-Host "`n[MISSING] C:/external/ode/include/ode/ode.h"
              # Try to find ode.h anywhere in ODE directory
              Write-Host "Searching for ode.h..."
              Get-ChildItem "C:/external/ode" -Recurse -Filter "ode.h" -ErrorAction SilentlyContinue |
                Select-Object FullName |
                ForEach-Object { Write-Host "Found: $($_.FullName)" }
            }

            # Check for ODE library and determine correct name
            Write-Host "`nLooking for ODE library..."
            $odeLib = Get-ChildItem "C:/external/ode/lib" -Filter "ode*.lib" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($odeLib) {
              Write-Host "[OK] Found ODE library: $($odeLib.Name)"
              # Set environment variable for CMake
              echo "ODE_LIBRARY_NAME=$($odeLib.Name)" >> $env:GITHUB_ENV
            } else {
              Write-Error "[MISSING] No ODE library found in C:/external/ode/lib"
            }
          } else {
            Write-Error "ODE directory not found at C:/external/ode"
          }

      - name: Configure CMake (Server)
        shell: pwsh
        run: |
          mkdir build-server
          cd build-server
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DBUILD_CLIENT=OFF `
            -DBUILD_SERVER=ON `
            -DNEL_PREFIX_PATH=C:/ryzomcore/build `
            -DCMAKE_PREFIX_PATH=C:/external `
            -DLUA_INCLUDE_DIR=C:/external/lua/include `
            -DLUA_LIBRARIES=C:/external/lua/lib/lua.lib `
            -DLIBXML2_INCLUDE_DIR=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_ROOT=C:/external/zlib `
            -DFREETYPE_INCLUDE_DIRS=C:/external/freetype/include/freetype2 `
            -DFREETYPE_LIBRARY=C:/external/freetype/lib/freetype.lib `
            -DPNG_PNG_INCLUDE_DIR=C:/external/libpng/include `
            -DPNG_LIBRARY=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR=C:/external/libjpeg/include `
            -DJPEG_LIBRARY=C:/external/libjpeg/lib/jpeg.lib `
            -DODE_INCLUDE_DIR=C:/external/ode/include `
            -DODE_LIBRARY=C:/external/ode/lib/ode_doubles.lib

      - name: Verify CMake Server Config
        shell: pwsh
        run: |
          Write-Host "=== Checking generated build files ==="
          # Check if the include path is in the vcxproj
          $vcxproj = "build-server/server/src/tux-target-srv.vcxproj"
          if (Test-Path $vcxproj) {
            Write-Host "`nAdditionalIncludeDirectories from vcxproj:"
            Select-String -Path $vcxproj -Pattern "AdditionalIncludeDirectories" |
              ForEach-Object { Write-Host $_.Line }

            Write-Host "`nODE paths in vcxproj:"
            Select-String -Path $vcxproj -Pattern "ode" -CaseSensitive:$false |
              ForEach-Object { Write-Host $_.Line }
          } else {
            Write-Host "vcxproj not found at expected path"
            Get-ChildItem "build-server" -Recurse -Filter "*.vcxproj" |
              Select-Object FullName |
              ForEach-Object { Write-Host "Found: $($_.FullName)" }
          }

      - name: Build Server
        run: cmake --build build-server --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Prepare Server Artifact
        shell: pwsh
        run: |
          $releaseDir = "build-server/bin/${{ env.BUILD_TYPE }}"
          $depsDir = "C:/external"

          # Copy runtime DLLs from dependencies
          # Note: ODE is statically linked (x64-windows-static-md), no DLL needed
          $dllSources = @(
            "$depsDir/lua/bin/lua.dll",
            "$depsDir/zlib/bin/zlib.dll",
            "$depsDir/freetype/bin/freetype.dll",
            "$depsDir/libpng/bin/libpng16.dll",
            "$depsDir/libjpeg/bin/jpeg62.dll"
          )
          foreach ($dll in $dllSources) {
            if (Test-Path $dll) {
              Copy-Item $dll "$releaseDir/" -ErrorAction SilentlyContinue
              Write-Host "Copied: $dll"
            } else {
              Write-Warning "DLL not found: $dll"
            }
          }

          # Copy ALL game data (shapes, textures, levels, etc.) - server serves these to clients
          Write-Host "Copying game data..."
          if (Test-Path "data") {
            New-Item -ItemType Directory -Force -Path "$releaseDir/data" | Out-Null
            Copy-Item -Recurse -Force "data/*" "$releaseDir/data/"
            Write-Host "Copied data directory"
          }

          # Copy helpers.lua (required for include() function in level scripts)
          if (Test-Path "server/data/misc/helpers.lua") {
            Copy-Item "server/data/misc/helpers.lua" "$releaseDir/data/"
            Write-Host "Copied: helpers.lua"
          }

          # Create additional directories
          New-Item -ItemType Directory -Force -Path "$releaseDir/logs" | Out-Null

          # Copy config
          if (Test-Path "server/mtp_target_service_default.cfg") {
            Copy-Item "server/mtp_target_service_default.cfg" "$releaseDir/mtp_target_service.cfg"
            Write-Host "Copied: mtp_target_service.cfg"
          }

      - name: Upload Server Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tux-target-server-windows-${{ env.BUILD_TYPE }}
          path: |
            build-server/bin/${{ env.BUILD_TYPE }}/tux-target-srv.exe
            build-server/bin/${{ env.BUILD_TYPE }}/*.dll
            build-server/bin/${{ env.BUILD_TYPE }}/data/
            build-server/bin/${{ env.BUILD_TYPE }}/*.cfg
          retention-days: 30

  # ============================================
  # Build Summary
  # ============================================
  build-summary:
    name: Build Summary
    needs: [build-client, build-server]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Client | ${{ needs.build-client.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.build-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build type: **${{ env.BUILD_TYPE }}**" >> $GITHUB_STEP_SUMMARY
