name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build configuration'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

env:
  BUILD_TYPE: ${{ inputs.build_type || 'Release' }}
  # Enable vcpkg binary caching
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  # ============================================
  # Build Dependencies (cached)
  # ============================================
  build-deps:
    name: Build Dependencies
    runs-on: windows-2022
    outputs:
      deps-cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      ryzomcore-cache-hit: ${{ steps.cache-ryzomcore.outputs.cache-hit }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      # STEP 1: Download external dependencies FIRST (RyzomCore needs these to build)
      # NOTE: No restore-keys - we need exact cache match to ensure ODE triplet is correct
      - name: Cache Dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v11

      - name: Download External Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "Downloading Ryzom external dependencies (1.3GB)..."
          $url = "https://cdn.ryzom.dev/core/2022q2_external_v143_x64.7z"
          $output = "C:/external.7z"

          # Download with progress disabled for speed
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          $ProgressPreference = 'Continue'

          # Create target directory
          New-Item -ItemType Directory -Force -Path "C:/external"

          Write-Host "Extracting dependencies to C:/external..."
          7z x $output -oC:/external -y

          # List what was extracted (both files and directories)
          Write-Host "Extracted contents (directories):"
          Get-ChildItem C:/external -Directory | Select-Object Name
          Write-Host "Extracted contents (files at root):"
          Get-ChildItem C:/external -File | Select-Object Name

          # RyzomCore requires CMakeLists.txt in external directory
          if (!(Test-Path "C:/external/CMakeLists.txt")) {
            Write-Warning "CMakeLists.txt not found in C:/external - checking for nested structure..."

            # Check if there's a nested "external" folder from the archive
            $nested = Get-ChildItem C:/external -Directory | Where-Object {
              Test-Path "$($_.FullName)/CMakeLists.txt"
            } | Select-Object -First 1

            if ($nested) {
              Write-Host "Found CMakeLists.txt in nested folder: $($nested.Name)"
              Write-Host "Moving contents up one level..."
              Get-ChildItem $nested.FullName | Move-Item -Destination "C:/external/" -Force
              Remove-Item $nested.FullName -Recurse -Force -ErrorAction SilentlyContinue
            } else {
              Write-Warning "No CMakeLists.txt found in any subdirectory"
              Write-Host "This external package may not be compatible with RyzomCore"
            }
          }

          # Verify key directories exist (lua, libxml2, etc.)
          $required = @("lua", "libxml2", "zlib")
          foreach ($dir in $required) {
            if (!(Test-Path "C:/external/$dir")) {
              Write-Warning "Expected directory not found: $dir"
            } else {
              Write-Host "Found: $dir"
            }
          }

          # Cleanup archive to save space
          Remove-Item $output

          # Remove all OpenSSL libs except the specific release ones we need
          # (FindOpenSSL returns "optimized;...;debug;..." format which modern CMake
          # doesn't allow in INTERFACE_LINK_LIBRARIES)
          Write-Host "`nCleaning OpenSSL libs - keeping only release MSVC libs..."
          $keepLibs = @(
            "libcrypto64MD.lib",
            "libssl64MD.lib"
          )
          # Delete all .lib files in openssl/lib recursively, except the ones we want (by filename)
          Get-ChildItem "C:/external/openssl/lib" -Recurse -Filter "*.lib" | ForEach-Object {
            if ($keepLibs -notcontains $_.Name) {
              Remove-Item $_.FullName -Force
              Write-Host "Removed: $($_.FullName)"
            } else {
              Write-Host "Kept: $($_.FullName)"
            }
          }

          # Also remove Luabind debug lib
          if (Test-Path "C:/external/luabind/lib/luabindd.lib") {
            Remove-Item "C:/external/luabind/lib/luabindd.lib" -Force
            Write-Host "Removed: C:/external/luabind/lib/luabindd.lib"
          }

          # Remove libxml2 debug lib
          if (Test-Path "C:/external/libxml2/lib/libxml2d.lib") {
            Remove-Item "C:/external/libxml2/lib/libxml2d.lib" -Force
            Write-Host "Removed: C:/external/libxml2/lib/libxml2d.lib"
          }

          Write-Host "External dependencies ready at C:/external"
          Write-Host "Final structure:"
          Get-ChildItem C:/external | Select-Object Mode, Name

          # Show Ryzom's recommended CMake prefix path
          if (Test-Path "C:/external/cmake_prefix_path_ryz.txt") {
            Write-Host "`nRyzom CMAKE_PREFIX_PATH recommendation:"
            Get-Content "C:/external/cmake_prefix_path_ryz.txt"
          }

          # Check libxml2 structure for iconv
          Write-Host "`nlibxml2 lib contents:"
          Get-ChildItem "C:/external/libxml2/lib" -ErrorAction SilentlyContinue

      # Install ODE physics library (not in Ryzom external package)
      - name: Install ODE
        shell: pwsh
        run: |
          # Skip if ODE already exists from cache
          if (Test-Path "C:/external/ode/include/ode/ode.h") {
            Write-Host "ODE already installed, skipping..."
            exit 0
          }

          Write-Host "Installing ODE via vcpkg..."
          # vcpkg is pre-installed on GitHub Actions runners
          # Use x64-windows-static-md triplet: static library with dynamic CRT (/MD)
          # This matches how tux_target is built (dynamic CRT)
          vcpkg install ode:x64-windows-static-md

          # Copy to C:/external/ode for consistency
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          if (-not $vcpkgRoot) {
            $vcpkgRoot = "C:\vcpkg"
          }

          $installedDir = "$vcpkgRoot\installed\x64-windows-static-md"
          if (Test-Path $installedDir) {
            New-Item -ItemType Directory -Force -Path "C:/external/ode/include"
            New-Item -ItemType Directory -Force -Path "C:/external/ode/lib"

            # Copy headers
            if (Test-Path "$installedDir/include/ode") {
              Copy-Item -Recurse "$installedDir/include/ode" "C:/external/ode/include/"
              Write-Host "Copied ODE headers"
            }

            # Copy libraries - ODE names vary: ode.lib, ode_double.lib, ode_doubles.lib
            # Copy all found libs and create a consistent name (ode_doubles.lib) for our CMake
            Get-ChildItem "$installedDir/lib" -Filter "ode*.lib" | ForEach-Object {
              Copy-Item $_.FullName "C:/external/ode/lib/"
              Write-Host "Copied: $($_.Name)"
              # Also copy as ode_doubles.lib if it has a different name
              if ($_.Name -ne "ode_doubles.lib") {
                Copy-Item $_.FullName "C:/external/ode/lib/ode_doubles.lib"
                Write-Host "Also copied as: ode_doubles.lib"
              }
            }

            Write-Host "`nODE installation complete:"
            Get-ChildItem "C:/external/ode" -Recurse | Select-Object FullName
          } else {
            Write-Error "vcpkg install directory not found: $installedDir"
          }

      # Verify deps exist (runs even with cache hit for debugging)
      - name: Verify Dependencies
        shell: pwsh
        run: |
          Write-Host "=== Verifying external dependencies ==="
          Write-Host "`nlibxml2 lib contents:"
          Get-ChildItem "C:/external/libxml2/lib" -Filter "*.lib" -ErrorAction SilentlyContinue
          Write-Host "`nOpenSSL lib contents:"
          Get-ChildItem "C:/external/openssl/lib/VC" -Filter "*.lib" -ErrorAction SilentlyContinue
          Write-Host "`nLuabind lib contents:"
          Get-ChildItem "C:/external/luabind/lib" -Filter "*.lib" -ErrorAction SilentlyContinue
          Write-Host "`nODE structure:"
          if (Test-Path "C:/external/ode") {
            Get-ChildItem "C:/external/ode" -Recurse -Include "*.h","*.lib" | Select-Object FullName
          } else {
            Write-Host "ODE directory not found!"
          }

      # STEP 2: Build RyzomCore (requires external deps)
      - name: Cache RyzomCore
        id: cache-ryzomcore
        uses: actions/cache@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v16
          # No restore-keys fallback - we want exact match only to avoid stale caches

      - name: Build RyzomCore
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Clean up any stale directory from failed cache restore
          if (Test-Path "C:/ryzomcore") {
            Remove-Item -Recurse -Force "C:/ryzomcore"
          }

          Write-Host "Cloning RyzomCore..."
          git clone --depth 1 https://github.com/ryzom/ryzomcore.git C:/ryzomcore

          Write-Host "Configuring RyzomCore..."
          cd C:/ryzomcore
          mkdir build
          cd build

          # Point to external dependencies via CMAKE_PREFIX_PATH
          # (Don't use WITH_EXTERNAL as it requires a CMakeLists.txt in external dir)
          #
          # Read recommended paths from the external package
          # Use the exact CMAKE_PREFIX_PATH from cmake_prefix_path_ryz.txt
          $cmakePrefixPath = "C:/external/zlib;C:/external/libpng;C:/external/libjpeg;C:/external/curl;C:/external/openssl;C:/external/freetype;C:/external/ogg;C:/external/vorbis;C:/external/openal-soft;C:/external/boost;C:/external/lua;C:/external/luabind;C:/external/libxml2"

          # Use Ninja generator - it respects compile flags better than VS generator
          # Find cl.exe using where.exe (more reliable than relying on PATH in cmake)
          $ninjaPath = "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe"
          $clPath = (Get-Command cl.exe -ErrorAction SilentlyContinue).Source
          if (-not $clPath) {
            # Fallback: use where.exe
            $clPath = (where.exe cl.exe 2>$null | Select-Object -First 1)
          }
          if (-not $clPath) {
            Write-Error "Could not find cl.exe! MSVC environment may not be set up correctly."
            exit 1
          }
          Write-Host "Found cl.exe at: $clPath"

          # Set LIBXML_STATIC via environment variables - more reliable than CMAKE_*_FLAGS
          # CMake uses these to initialize CMAKE_C_FLAGS and CMAKE_CXX_FLAGS
          $env:CFLAGS = "/DLIBXML_STATIC"
          $env:CXXFLAGS = "/DLIBXML_STATIC"
          Write-Host "Set CFLAGS=$env:CFLAGS"
          Write-Host "Set CXXFLAGS=$env:CXXFLAGS"

          cmake .. -G Ninja `
            -DCMAKE_MAKE_PROGRAM="$ninjaPath" `
            -DCMAKE_C_COMPILER="$clPath" `
            -DCMAKE_CXX_COMPILER="$clPath" `
            -DCMAKE_BUILD_TYPE=Release `
            -DWITH_SOUND=ON `
            -DWITH_NEL=ON `
            -DWITH_NEL_TOOLS=OFF `
            -DWITH_NEL_TESTS=OFF `
            -DWITH_NEL_SAMPLES=OFF `
            -DWITH_RYZOM=OFF `
            -DWITH_RYZOM_CLIENT=OFF `
            -DWITH_RYZOM_SERVER=OFF `
            -DWITH_RYZOM_TOOLS=OFF `
            -DWITH_NELNS=OFF `
            -DWITH_SNOWBALLS=OFF `
            -DWITH_STATIC=ON `
            -DWITH_STATIC_LIBXML2=ON `
            -DLIBXML2_DEFINITIONS=-DLIBXML_STATIC `
            "-DCMAKE_PREFIX_PATH=$cmakePrefixPath" `
            -DLUA_INCLUDE_DIR=C:/external/lua/include `
            -DLUA_LIBRARIES=C:/external/lua/lib/lua51.lib `
            -DLUABIND_INCLUDE_DIR=C:/external/luabind/include `
            -DLUABIND_LIBRARY=C:/external/luabind/lib/luabind.lib `
            -DLUABIND_LIBRARIES=C:/external/luabind/lib/luabind.lib `
            -DLIBXML2_INCLUDE_DIR=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY=C:/external/libxml2/lib/libxml2.lib `
            -DLIBXML2_LIBRARIES=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_INCLUDE_DIR=C:/external/zlib/include `
            -DZLIB_LIBRARIES=C:/external/zlib/lib/zlib.lib `
            -DZLIB_LIBRARY=C:/external/zlib/lib/zlib.lib `
            -DPNG_PNG_INCLUDE_DIR=C:/external/libpng/include `
            -DPNG_LIBRARY=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR=C:/external/libjpeg/include `
            -DJPEG_LIBRARY=C:/external/libjpeg/lib/jpeg.lib `
            -DFREETYPE_INCLUDE_DIRS=C:/external/freetype/include `
            -DFREETYPE_LIBRARY=C:/external/freetype/lib/freetype.lib `
            -DOPENAL_INCLUDE_DIR=C:/external/openal-soft/include `
            -DOPENAL_LIBRARY=C:/external/openal-soft/lib/OpenAL32.lib `
            -DOGG_INCLUDE_DIR=C:/external/ogg/include `
            -DOGG_LIBRARY=C:/external/ogg/lib/ogg.lib `
            -DVORBIS_INCLUDE_DIR=C:/external/vorbis/include `
            -DVORBIS_LIBRARY=C:/external/vorbis/lib/vorbis.lib `
            -DVORBISFILE_LIBRARY=C:/external/vorbis/lib/vorbisfile.lib `
            -DBoost_INCLUDE_DIR=C:/external/boost/include `
            -DOPENSSL_ROOT_DIR=C:/external/openssl `
            -DOPENSSL_CRYPTO_LIBRARY=C:/external/openssl/lib/VC/libcrypto64MD.lib `
            -DOPENSSL_SSL_LIBRARY=C:/external/openssl/lib/VC/libssl64MD.lib `
            -DOPENSSL_LIBRARIES="C:/external/openssl/lib/VC/libcrypto64MD.lib;C:/external/openssl/lib/VC/libssl64MD.lib" `
            -DCMAKE_FIND_USE_SYSTEM_ENVIRONMENT_PATH=FALSE

          Write-Host "Building RyzomCore..."
          # Ninja doesn't need --config, build type is set at configure time
          cmake --build . --parallel 4 --target nelmisc nelnet nel3d nelsound nelsnd_lowlevel nelgeorges nelligo
          cmake --build . --parallel 2 --target nel_drv_opengl_win nel_drv_openal_win

      - name: Verify RyzomCore Build
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Ninja outputs to lib/ and bin/ directly (no Release subdirectory)
          $required = @(
            "C:/ryzomcore/build/lib/nelmisc_r.lib",
            "C:/ryzomcore/build/lib/nel3d_r.lib",
            "C:/ryzomcore/build/lib/nelnet_r.lib",
            "C:/ryzomcore/build/lib/nelsound_r.lib",
            "C:/ryzomcore/build/lib/nelsnd_lowlevel_r.lib",
            "C:/ryzomcore/build/lib/nelgeorges_r.lib",
            "C:/ryzomcore/build/lib/nelligo_r.lib",
            "C:/ryzomcore/build/bin/nel_drv_opengl_win_r.dll",
            "C:/ryzomcore/build/bin/nel_drv_openal_win_r.dll"
          )
          $missing = @()
          foreach ($file in $required) {
            if (!(Test-Path $file)) {
              $missing += $file
            }
          }
          if ($missing.Count -gt 0) {
            Write-Error "RyzomCore build incomplete. Missing files:"
            $missing | ForEach-Object { Write-Error "  - $_" }
            exit 1
          }
          Write-Host "RyzomCore build verified successfully - all $($required.Count) files present"

  # ============================================
  # Build Client
  # ============================================
  build-client:
    name: Build Client
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v16
          fail-on-cache-miss: true

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v11
          restore-keys: |
            ryzom-external-2022q2-

      - name: Verify Library Paths
        shell: pwsh
        run: |
          Write-Host "=== Verifying library paths for client build ==="
          $libs = @(
            "C:/external/libxml2/lib/libxml2.lib",
            "C:/external/zlib/lib/zlib.lib",
            "C:/external/lua/lib/lua.lib",
            "C:/external/curl/lib/libcurl_imp.lib"
          )
          foreach ($lib in $libs) {
            if (Test-Path $lib) {
              Write-Host "[OK] $lib"
            } else {
              Write-Error "[MISSING] $lib"
            }
          }

      - name: Configure CMake (Client)
        shell: pwsh
        run: |
          mkdir build-client
          cd build-client
          # Use :FILEPATH type to ensure CMake treats these as cache variables
          # that won't be overwritten by find modules
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DBUILD_CLIENT=ON `
            -DBUILD_SERVER=OFF `
            -DWITH_STATIC=ON `
            -DWITH_STATIC_LIBXML2=ON `
            -DWITH_STATIC_CURL=ON `
            -DNEL_PREFIX_PATH=C:/ryzomcore/build `
            -DCMAKE_PREFIX_PATH=C:/external `
            -DLUA_INCLUDE_DIR:PATH=C:/external/lua/include `
            -DLUA_LIBRARIES:FILEPATH=C:/external/lua/lib/lua.lib `
            -DLIBXML2_INCLUDE_DIR:PATH=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY:FILEPATH=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_ROOT=C:/external/zlib `
            -DZLIB_LIBRARY:FILEPATH=C:/external/zlib/lib/zlib.lib `
            -DCURL_ROOT=C:/external/curl `
            -DCURL_LIBRARIES:FILEPATH=C:/external/curl/lib/libcurl_imp.lib `
            -DOPENSSL_ROOT_DIR=C:/external/openssl `
            -DFREETYPE_INCLUDE_DIRS:PATH=C:/external/freetype/include `
            -DFREETYPE_LIBRARY:FILEPATH=C:/external/freetype/lib/freetype.lib `
            -DPNG_PNG_INCLUDE_DIR:PATH=C:/external/libpng/include `
            -DPNG_LIBRARY:FILEPATH=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR:PATH=C:/external/libjpeg/include `
            -DJPEG_LIBRARY:FILEPATH=C:/external/libjpeg/lib/jpeg.lib `
            -DVORBIS_LIBRARY:FILEPATH=C:/external/vorbis/lib/vorbis.lib `
            -DVORBISFILE_LIBRARY:FILEPATH=C:/external/vorbis/lib/vorbisfile.lib `
            -DOGG_LIBRARY:FILEPATH=C:/external/ogg/lib/ogg.lib

      - name: Build Client
        run: cmake --build build-client --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Prepare Client Artifact
        shell: pwsh
        run: |
          $releaseDir = "build-client/bin/${{ env.BUILD_TYPE }}"
          $depsDir = "C:/external"

          # Copy NeL drivers (Ninja outputs to bin/ directly, no Release subdirectory)
          if (Test-Path "C:/ryzomcore/build/bin/nel_drv_opengl_win_r.dll") {
            Copy-Item "C:/ryzomcore/build/bin/nel_drv_opengl_win_r.dll" "$releaseDir/"
          }
          if (Test-Path "C:/ryzomcore/build/bin/nel_drv_openal_win_r.dll") {
            Copy-Item "C:/ryzomcore/build/bin/nel_drv_openal_win_r.dll" "$releaseDir/"
          }

          # Copy runtime DLLs from dependencies
          $dllSources = @(
            "$depsDir/lua/bin/lua.dll",
            "$depsDir/libxml2/bin/libxml2.dll",
            "$depsDir/zlib/bin/zlib.dll",
            "$depsDir/curl/bin/libcurl.dll",
            "$depsDir/openssl/bin/libcrypto-1_1-x64.dll",
            "$depsDir/openssl/bin/libssl-1_1-x64.dll",
            "$depsDir/freetype/bin/freetype.dll",
            "$depsDir/libpng/bin/libpng16.dll",
            "$depsDir/libjpeg/bin/jpeg62.dll",
            "$depsDir/ogg/bin/ogg.dll",
            "$depsDir/vorbis/bin/vorbis.dll",
            "$depsDir/vorbis/bin/vorbisfile.dll",
            "$depsDir/openal-soft/bin/OpenAL32.dll"
          )
          foreach ($dll in $dllSources) {
            if (Test-Path $dll) {
              Copy-Item $dll "$releaseDir/" -ErrorAction SilentlyContinue
              Write-Host "Copied: $dll"
            } else {
              Write-Warning "DLL not found: $dll"
            }
          }

          # Create data directories
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/font"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/level"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/gui"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/shape"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/texture"
          New-Item -ItemType Directory -Force -Path "$releaseDir/logs"

          # Copy level files
          if (Test-Path "data/level") {
            Copy-Item "data/level/*.lua" "$releaseDir/data/level/" -ErrorAction SilentlyContinue
          }

          # Copy config
          if (Test-Path "data/config/mtp_target_default.cfg") {
            Copy-Item "data/config/mtp_target_default.cfg" "$releaseDir/"
          } elseif (Test-Path "client/mtp_target_default.cfg") {
            Copy-Item "client/mtp_target_default.cfg" "$releaseDir/"
          }

      - name: Upload Client Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tux-target-client-windows-${{ env.BUILD_TYPE }}
          path: |
            build-client/bin/${{ env.BUILD_TYPE }}/tux-target.exe
            build-client/bin/${{ env.BUILD_TYPE }}/*.dll
            build-client/bin/${{ env.BUILD_TYPE }}/data/
            build-client/bin/${{ env.BUILD_TYPE }}/*.cfg
          retention-days: 30

  # ============================================
  # Build Server
  # ============================================
  build-server:
    name: Build Server
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v16
          fail-on-cache-miss: true

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v11
          restore-keys: |
            ryzom-external-2022q2-

      - name: Verify ODE Installation
        shell: pwsh
        run: |
          Write-Host "=== Checking ODE directory structure ==="
          if (Test-Path "C:/external/ode") {
            Write-Host "ODE directory exists"
            Write-Host "`nODE include structure:"
            Get-ChildItem "C:/external/ode/include" -Recurse -ErrorAction SilentlyContinue |
              Select-Object FullName |
              ForEach-Object { Write-Host $_.FullName }

            Write-Host "`nODE lib structure:"
            Get-ChildItem "C:/external/ode/lib" -Recurse -Filter "*.lib" -ErrorAction SilentlyContinue |
              Select-Object FullName |
              ForEach-Object { Write-Host $_.FullName }

            # Check specifically for ode/ode.h
            if (Test-Path "C:/external/ode/include/ode/ode.h") {
              Write-Host "`n[OK] Found: C:/external/ode/include/ode/ode.h"
            } else {
              Write-Host "`n[MISSING] C:/external/ode/include/ode/ode.h"
              # Try to find ode.h anywhere in ODE directory
              Write-Host "Searching for ode.h..."
              Get-ChildItem "C:/external/ode" -Recurse -Filter "ode.h" -ErrorAction SilentlyContinue |
                Select-Object FullName |
                ForEach-Object { Write-Host "Found: $($_.FullName)" }
            }

            # Check for ODE library and determine correct name
            Write-Host "`nLooking for ODE library..."
            $odeLib = Get-ChildItem "C:/external/ode/lib" -Filter "ode*.lib" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($odeLib) {
              Write-Host "[OK] Found ODE library: $($odeLib.Name)"
              # Set environment variable for CMake
              echo "ODE_LIBRARY_NAME=$($odeLib.Name)" >> $env:GITHUB_ENV
            } else {
              Write-Error "[MISSING] No ODE library found in C:/external/ode/lib"
            }
          } else {
            Write-Error "ODE directory not found at C:/external/ode"
          }

      - name: Configure CMake (Server)
        shell: pwsh
        run: |
          mkdir build-server
          cd build-server
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DBUILD_CLIENT=OFF `
            -DBUILD_SERVER=ON `
            -DNEL_PREFIX_PATH=C:/ryzomcore/build `
            -DCMAKE_PREFIX_PATH=C:/external `
            -DLUA_INCLUDE_DIR=C:/external/lua/include `
            -DLUA_LIBRARIES=C:/external/lua/lib/lua.lib `
            -DLIBXML2_INCLUDE_DIR=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_ROOT=C:/external/zlib `
            -DFREETYPE_INCLUDE_DIRS=C:/external/freetype/include `
            -DFREETYPE_LIBRARY=C:/external/freetype/lib/freetype.lib `
            -DPNG_PNG_INCLUDE_DIR=C:/external/libpng/include `
            -DPNG_LIBRARY=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR=C:/external/libjpeg/include `
            -DJPEG_LIBRARY=C:/external/libjpeg/lib/jpeg.lib `
            -DODE_INCLUDE_DIR=C:/external/ode/include `
            -DODE_LIBRARY=C:/external/ode/lib/ode_doubles.lib

      - name: Verify CMake Server Config
        shell: pwsh
        run: |
          Write-Host "=== Checking generated build files ==="
          # Check if the include path is in the vcxproj
          $vcxproj = "build-server/server/src/tux-target-srv.vcxproj"
          if (Test-Path $vcxproj) {
            Write-Host "`nAdditionalIncludeDirectories from vcxproj:"
            Select-String -Path $vcxproj -Pattern "AdditionalIncludeDirectories" |
              ForEach-Object { Write-Host $_.Line }

            Write-Host "`nODE paths in vcxproj:"
            Select-String -Path $vcxproj -Pattern "ode" -CaseSensitive:$false |
              ForEach-Object { Write-Host $_.Line }
          } else {
            Write-Host "vcxproj not found at expected path"
            Get-ChildItem "build-server" -Recurse -Filter "*.vcxproj" |
              Select-Object FullName |
              ForEach-Object { Write-Host "Found: $($_.FullName)" }
          }

      - name: Build Server
        run: cmake --build build-server --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Prepare Server Artifact
        shell: pwsh
        run: |
          $releaseDir = "build-server/bin/${{ env.BUILD_TYPE }}"
          $depsDir = "C:/external"

          # Copy runtime DLLs from dependencies
          $dllSources = @(
            "$depsDir/lua/bin/lua.dll",
            "$depsDir/zlib/bin/zlib.dll",
            "$depsDir/freetype/bin/freetype.dll",
            "$depsDir/libpng/bin/libpng16.dll",
            "$depsDir/libjpeg/bin/jpeg62.dll",
            "$depsDir/ode/bin/ode.dll"
          )
          foreach ($dll in $dllSources) {
            if (Test-Path $dll) {
              Copy-Item $dll "$releaseDir/" -ErrorAction SilentlyContinue
              Write-Host "Copied: $dll"
            } else {
              Write-Warning "DLL not found: $dll"
            }
          }

          # Create data directories
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/level"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/lua"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/module"
          New-Item -ItemType Directory -Force -Path "$releaseDir/logs"

          # Copy level files
          if (Test-Path "data/level") {
            Copy-Item "data/level/*.lua" "$releaseDir/data/level/" -ErrorAction SilentlyContinue
          }

          # Copy Lua server scripts (fixed path from mtp-target-src to data)
          if (Test-Path "data/lua") {
            Copy-Item "data/lua/*.lua" "$releaseDir/data/lua/" -ErrorAction SilentlyContinue
          }

          # Copy module Lua scripts
          if (Test-Path "data/module") {
            Copy-Item "data/module/*.lua" "$releaseDir/data/module/" -ErrorAction SilentlyContinue
          }

          # Copy config
          if (Test-Path "server/mtp_target_service_default.cfg") {
            Copy-Item "server/mtp_target_service_default.cfg" "$releaseDir/mtp_target_service.cfg"
          }

      - name: Upload Server Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tux-target-server-windows-${{ env.BUILD_TYPE }}
          path: |
            build-server/bin/${{ env.BUILD_TYPE }}/tux-target-srv.exe
            build-server/bin/${{ env.BUILD_TYPE }}/*.dll
            build-server/bin/${{ env.BUILD_TYPE }}/data/
            build-server/bin/${{ env.BUILD_TYPE }}/*.cfg
          retention-days: 30

  # ============================================
  # Build Summary
  # ============================================
  build-summary:
    name: Build Summary
    needs: [build-client, build-server]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Client | ${{ needs.build-client.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.build-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build type: **${{ env.BUILD_TYPE }}**" >> $GITHUB_STEP_SUMMARY
