name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build configuration'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

env:
  BUILD_TYPE: ${{ inputs.build_type || 'Release' }}
  # Enable vcpkg binary caching
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  # ============================================
  # Build Dependencies (cached)
  # ============================================
  build-deps:
    name: Build Dependencies
    runs-on: windows-2022
    outputs:
      deps-cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      ryzomcore-cache-hit: ${{ steps.cache-ryzomcore.outputs.cache-hit }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # STEP 1: Download external dependencies FIRST (RyzomCore needs these to build)
      - name: Cache Dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v1
          restore-keys: |
            ryzom-external-2022q2-

      - name: Download External Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "Downloading Ryzom external dependencies (1.3GB)..."
          $url = "https://cdn.ryzom.dev/core/2022q2_external_v143_x64.7z"
          $output = "C:/external.7z"

          # Download with progress disabled for speed
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          $ProgressPreference = 'Continue'

          Write-Host "Extracting dependencies to C:/external..."
          7z x $output -oC:/ -y

          # The archive extracts to "external" folder
          if (!(Test-Path "C:/external")) {
            Write-Error "External directory not found after extraction"
            exit 1
          }

          # Cleanup archive to save space
          Remove-Item $output

          Write-Host "External dependencies ready at C:/external"
          Get-ChildItem C:/external -Directory | Select-Object Name

      # STEP 2: Build RyzomCore (requires external deps)
      - name: Cache RyzomCore
        id: cache-ryzomcore
        uses: actions/cache@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v2
          restore-keys: |
            ryzomcore-nel-

      - name: Build RyzomCore
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "Cloning RyzomCore..."
          git clone --depth 1 https://github.com/ryzom/ryzomcore.git C:/ryzomcore

          Write-Host "Configuring RyzomCore..."
          cd C:/ryzomcore
          mkdir build
          cd build

          # Point to external dependencies
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DWITH_SOUND=ON `
            -DWITH_NEL=ON `
            -DWITH_NEL_TOOLS=OFF `
            -DWITH_RYZOM=OFF `
            -DWITH_RYZOM_CLIENT=OFF `
            -DWITH_RYZOM_SERVER=OFF `
            -DWITH_RYZOM_TOOLS=OFF `
            -DWITH_NELNS=OFF `
            -DWITH_SNOWBALLS=OFF `
            -DWITH_STATIC=ON `
            -DWITH_EXTERNAL=ON `
            -DEXTERNAL_PATH=C:/external

          Write-Host "Building RyzomCore..."
          cmake --build . --config Release --parallel 4 --target nelmisc nelnet nel3d nelsound nelsnd_lowlevel nelgeorges nelligo
          cmake --build . --config Release --parallel 2 --target nel_drv_opengl_win nel_drv_openal_win

      - name: Verify RyzomCore Build
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $required = @(
            "C:/ryzomcore/build/lib/Release/nelmisc_r.lib",
            "C:/ryzomcore/build/lib/Release/nel3d_r.lib",
            "C:/ryzomcore/build/lib/Release/nelnet_r.lib",
            "C:/ryzomcore/build/lib/Release/nelsound_r.lib",
            "C:/ryzomcore/build/lib/Release/nelsnd_lowlevel_r.lib",
            "C:/ryzomcore/build/lib/Release/nelgeorges_r.lib",
            "C:/ryzomcore/build/lib/Release/nelligo_r.lib",
            "C:/ryzomcore/build/bin/Release/nel_drv_opengl_win_r.dll",
            "C:/ryzomcore/build/bin/Release/nel_drv_openal_win_r.dll"
          )
          $missing = @()
          foreach ($file in $required) {
            if (!(Test-Path $file)) {
              $missing += $file
            }
          }
          if ($missing.Count -gt 0) {
            Write-Error "RyzomCore build incomplete. Missing files:"
            $missing | ForEach-Object { Write-Error "  - $_" }
            exit 1
          }
          Write-Host "RyzomCore build verified successfully - all $($required.Count) files present"

  # ============================================
  # Build Client
  # ============================================
  build-client:
    name: Build Client
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v2
          restore-keys: |
            ryzomcore-nel-

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v1
          restore-keys: |
            ryzom-external-2022q2-

      - name: Configure CMake (Client)
        shell: pwsh
        run: |
          mkdir build-client
          cd build-client
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DBUILD_CLIENT=ON `
            -DBUILD_SERVER=OFF `
            -DWITH_STATIC=ON `
            -DWITH_STATIC_LIBXML2=ON `
            -DWITH_STATIC_CURL=ON `
            -DNEL_PREFIX_PATH=C:/ryzomcore/build `
            -DCMAKE_PREFIX_PATH=C:/external `
            -DLUA_INCLUDE_DIR=C:/external/lua/include `
            -DLUA_LIBRARIES=C:/external/lua/lib/lua.lib `
            -DLIBXML2_INCLUDE_DIR=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_ROOT=C:/external/zlib `
            -DCURL_ROOT=C:/external/curl `
            -DOPENSSL_ROOT_DIR=C:/external/openssl `
            -DFREETYPE_INCLUDE_DIRS=C:/external/freetype/include `
            -DFREETYPE_LIBRARY=C:/external/freetype/lib/freetype.lib `
            -DPNG_PNG_INCLUDE_DIR=C:/external/libpng/include `
            -DPNG_LIBRARY=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR=C:/external/libjpeg/include `
            -DJPEG_LIBRARY=C:/external/libjpeg/lib/jpeg.lib

      - name: Build Client
        run: cmake --build build-client --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Prepare Client Artifact
        shell: pwsh
        run: |
          $releaseDir = "build-client/bin/${{ env.BUILD_TYPE }}"
          $depsDir = "C:/external"

          # Copy NeL drivers
          if (Test-Path "C:/ryzomcore/build/bin/Release/nel_drv_opengl_win_r.dll") {
            Copy-Item "C:/ryzomcore/build/bin/Release/nel_drv_opengl_win_r.dll" "$releaseDir/"
          }
          if (Test-Path "C:/ryzomcore/build/bin/Release/nel_drv_openal_win_r.dll") {
            Copy-Item "C:/ryzomcore/build/bin/Release/nel_drv_openal_win_r.dll" "$releaseDir/"
          }

          # Copy runtime DLLs from dependencies
          $dllSources = @(
            "$depsDir/lua/bin/lua.dll",
            "$depsDir/libxml2/bin/libxml2.dll",
            "$depsDir/zlib/bin/zlib.dll",
            "$depsDir/curl/bin/libcurl.dll",
            "$depsDir/openssl/bin/libcrypto-1_1-x64.dll",
            "$depsDir/openssl/bin/libssl-1_1-x64.dll",
            "$depsDir/freetype/bin/freetype.dll",
            "$depsDir/libpng/bin/libpng16.dll",
            "$depsDir/libjpeg/bin/jpeg62.dll",
            "$depsDir/ogg/bin/ogg.dll",
            "$depsDir/vorbis/bin/vorbis.dll",
            "$depsDir/vorbis/bin/vorbisfile.dll",
            "$depsDir/openal-soft/bin/OpenAL32.dll"
          )
          foreach ($dll in $dllSources) {
            if (Test-Path $dll) {
              Copy-Item $dll "$releaseDir/" -ErrorAction SilentlyContinue
              Write-Host "Copied: $dll"
            } else {
              Write-Warning "DLL not found: $dll"
            }
          }

          # Create data directories
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/font"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/level"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/gui"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/shape"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/texture"
          New-Item -ItemType Directory -Force -Path "$releaseDir/logs"

          # Copy level files
          if (Test-Path "data/level") {
            Copy-Item "data/level/*.lua" "$releaseDir/data/level/" -ErrorAction SilentlyContinue
          }

          # Copy config
          if (Test-Path "data/config/mtp_target_default.cfg") {
            Copy-Item "data/config/mtp_target_default.cfg" "$releaseDir/"
          } elseif (Test-Path "client/mtp_target_default.cfg") {
            Copy-Item "client/mtp_target_default.cfg" "$releaseDir/"
          }

      - name: Upload Client Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tux-target-client-windows-${{ env.BUILD_TYPE }}
          path: |
            build-client/bin/${{ env.BUILD_TYPE }}/tux-target.exe
            build-client/bin/${{ env.BUILD_TYPE }}/*.dll
            build-client/bin/${{ env.BUILD_TYPE }}/data/
            build-client/bin/${{ env.BUILD_TYPE }}/*.cfg
          retention-days: 30

  # ============================================
  # Build Server
  # ============================================
  build-server:
    name: Build Server
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-nel-v2
          restore-keys: |
            ryzomcore-nel-

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: ryzom-external-2022q2-v1
          restore-keys: |
            ryzom-external-2022q2-

      - name: Configure CMake (Server)
        shell: pwsh
        run: |
          mkdir build-server
          cd build-server
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DBUILD_CLIENT=OFF `
            -DBUILD_SERVER=ON `
            -DNEL_PREFIX_PATH=C:/ryzomcore/build `
            -DCMAKE_PREFIX_PATH=C:/external `
            -DLUA_INCLUDE_DIR=C:/external/lua/include `
            -DLUA_LIBRARIES=C:/external/lua/lib/lua.lib `
            -DLIBXML2_INCLUDE_DIR=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_ROOT=C:/external/zlib `
            -DFREETYPE_INCLUDE_DIRS=C:/external/freetype/include `
            -DFREETYPE_LIBRARY=C:/external/freetype/lib/freetype.lib `
            -DPNG_PNG_INCLUDE_DIR=C:/external/libpng/include `
            -DPNG_LIBRARY=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR=C:/external/libjpeg/include `
            -DJPEG_LIBRARY=C:/external/libjpeg/lib/jpeg.lib `
            -DODE_INCLUDE_DIR=C:/external/ode/include `
            -DODE_LIBRARY=C:/external/ode/lib/ode_doubles.lib

      - name: Build Server
        run: cmake --build build-server --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Prepare Server Artifact
        shell: pwsh
        run: |
          $releaseDir = "build-server/bin/${{ env.BUILD_TYPE }}"
          $depsDir = "C:/external"

          # Copy runtime DLLs from dependencies
          $dllSources = @(
            "$depsDir/lua/bin/lua.dll",
            "$depsDir/zlib/bin/zlib.dll",
            "$depsDir/freetype/bin/freetype.dll",
            "$depsDir/libpng/bin/libpng16.dll",
            "$depsDir/libjpeg/bin/jpeg62.dll",
            "$depsDir/ode/bin/ode.dll"
          )
          foreach ($dll in $dllSources) {
            if (Test-Path $dll) {
              Copy-Item $dll "$releaseDir/" -ErrorAction SilentlyContinue
              Write-Host "Copied: $dll"
            } else {
              Write-Warning "DLL not found: $dll"
            }
          }

          # Create data directories
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/level"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/lua"
          New-Item -ItemType Directory -Force -Path "$releaseDir/data/module"
          New-Item -ItemType Directory -Force -Path "$releaseDir/logs"

          # Copy level files
          if (Test-Path "data/level") {
            Copy-Item "data/level/*.lua" "$releaseDir/data/level/" -ErrorAction SilentlyContinue
          }

          # Copy Lua server scripts (fixed path from mtp-target-src to data)
          if (Test-Path "data/lua") {
            Copy-Item "data/lua/*.lua" "$releaseDir/data/lua/" -ErrorAction SilentlyContinue
          }

          # Copy module Lua scripts
          if (Test-Path "data/module") {
            Copy-Item "data/module/*.lua" "$releaseDir/data/module/" -ErrorAction SilentlyContinue
          }

          # Copy config
          if (Test-Path "server/mtp_target_service_default.cfg") {
            Copy-Item "server/mtp_target_service_default.cfg" "$releaseDir/mtp_target_service.cfg"
          }

      - name: Upload Server Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tux-target-server-windows-${{ env.BUILD_TYPE }}
          path: |
            build-server/bin/${{ env.BUILD_TYPE }}/tux-target-srv.exe
            build-server/bin/${{ env.BUILD_TYPE }}/*.dll
            build-server/bin/${{ env.BUILD_TYPE }}/data/
            build-server/bin/${{ env.BUILD_TYPE }}/*.cfg
          retention-days: 30

  # ============================================
  # Build Summary
  # ============================================
  build-summary:
    name: Build Summary
    needs: [build-client, build-server]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Client | ${{ needs.build-client.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.build-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build type: **${{ env.BUILD_TYPE }}**" >> $GITHUB_STEP_SUMMARY
